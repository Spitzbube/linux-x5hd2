#include <linux/kernel.h>
#include <linux/errno.h>
#include <linux/unistd.h>
#include <linux/interrupt.h>
#include <linux/delay.h>
#include <linux/netdevice.h>
#include <linux/etherdevice.h>
#include <linux/skbuff.h>
#include <linux/spinlock.h>
#include <linux/mm.h>
#include <linux/mii.h>
#include <linux/ethtool.h>
#include <linux/phy.h>
#include <linux/dma-mapping.h>
#include <linux/device.h>
#include <linux/platform_device.h>
#include <linux/module.h>
#include <asm/atomic.h>
#include <asm/setup.h>

#include "hieth.h"
#include "mdio.h"
#include "mac.h"
#include "ctrl.h"
#include "glb.h"
#include "sys.h"
#include "phy_fix.h"

static const u32 phy_fix_param[] = {
	0x33f9,0xbd,
	0x33fa,0x34,
	0x33fb,0x00,
	0x33fc,0x39,
	0x3400,0x39,
	0x3401,0xCC,
	0x3402,0x10,
	0x3403,0x04,
	0x3404,0xFD,
	0x3405,0xFF,
	0x3406,0xF0,
	0x3407,0xF6,
	0x3408,0x36,
	0x3409,0x4F,
	0x340A,0x26,
	0x340B,0x41,
	0x340C,0xC6,
	0x340D,0x01,
	0x340E,0xF7,
	0x340F,0x36,
	0x3410,0x4F,
	0x3411,0xC6,
	0x3412,0xB0,
	0x3413,0xF7,
	0x3414,0x01,
	0x3415,0xFE,
	0x3416,0xC6,
	0x3417,0x0F,
	0x3418,0xF7,
	0x3419,0x01,
	0x341A,0xFF,
	0x341B,0x5C,
	0x341C,0xF7,
	0x341D,0x02,
	0x341E,0x00,
	0x341F,0xCC,
	0x3420,0x35,
	0x3421,0x0C,
	0x3422,0xFD,
	0x3423,0x00,
	0x3424,0xD1,
	0x3425,0xCC,
	0x3426,0x35,
	0x3427,0xFF,
	0x3428,0xFD,
	0x3429,0x00,
	0x342A,0xD3,
	0x342B,0xCC,
	0x342C,0x34,
	0x342D,0x9D,
	0x342E,0xFD,
	0x342F,0x01,
	0x3430,0xD6,
	0x3431,0xCC,
	0x3432,0x34,
	0x3433,0x4E,
	0x3434,0xFD,
	0x3435,0x30,
	0x3436,0x30,
	0x3437,0xF6,
	0x3438,0x20,
	0x3439,0xAA,
	0x343A,0xCB,
	0x343B,0x04,
	0x343C,0xC4,
	0x343D,0x1F,
	0x343E,0xF7,
	0x343F,0x36,
	0x3440,0x50,
	0x3441,0xC1,
	0x3442,0x0F,
	0x3443,0x23,
	0x3444,0x05,
	0x3445,0xC6,
	0x3446,0x0F,
	0x3447,0xF7,
	0x3448,0x36,
	0x3449,0x50,
	0x344A,0xF7,
	0x344B,0x20,
	0x344C,0xAA,
	0x344D,0x39,
	0x344E,0xC6,
	0x344F,0x77,
	0x3450,0xF7,
	0x3451,0x1C,
	0x3452,0xAB,
	0x3453,0xC6,
	0x3454,0x84,
	0x3455,0xF7,
	0x3456,0x1C,
	0x3457,0xA9,
	0x3458,0xC6,
	0x3459,0x08,
	0x345A,0xF7,
	0x345B,0x1C,
	0x345C,0xAA,
	0x345D,0xC6,
	0x345E,0x80,
	0x345F,0xF7,
	0x3460,0x1C,
	0x3461,0xAC,
	0x3462,0xC6,
	0x3463,0xEE,
	0x3464,0xF7,
	0x3465,0x1C,
	0x3466,0xAE,
	0x3467,0xC6,
	0x3468,0x01,
	0x3469,0xF7,
	0x346A,0x1C,
	0x346B,0xAF,
	0x346C,0xC6,
	0x346D,0xFF,
	0x346E,0xF7,
	0x346F,0x12,
	0x3470,0x90,
	0x3471,0xF7,
	0x3472,0x12,
	0x3473,0x91,
	0x3474,0xF7,
	0x3475,0x12,
	0x3476,0x92,
	0x3477,0xF7,
	0x3478,0x12,
	0x3479,0x93,
	0x347A,0xF7,
	0x347B,0x12,
	0x347C,0x94,
	0x347D,0xC6,
	0x347E,0x20,
	0x347F,0xF7,
	0x3480,0x1E,
	0x3481,0x0D,
	0x3482,0x7F,
	0x3483,0x12,
	0x3484,0x9E,
	0x3485,0xC6,
	0x3486,0xA2,
	0x3487,0xF7,
	0x3488,0x1C,
	0x3489,0xA9,
	0x348A,0x39,
	0x348B,0x18,
	0x348C,0xCE,
	0x348D,0x36,
	0x348E,0x48,
	0x348F,0x18,
	0x3490,0x3A,
	0x3491,0xF6,
	0x3492,0x20,
	0x3493,0x09,
	0x3494,0xC4,
	0x3495,0xF0,
	0x3496,0x18,
	0x3497,0xEA,
	0x3498,0x00,
	0x3499,0xF7,
	0x349A,0x20,
	0x349B,0x09,
	0x349C,0x39,
	0x349D,0xF6,
	0x349E,0x01,
	0x349F,0xEC,
	0x34A0,0x27,
	0x34A1,0x68,
	0x34A2,0xF6,
	0x34A3,0x20,
	0x34A4,0x09,
	0x34A5,0xC4,
	0x34A6,0x0F,
	0x34A7,0xF7,
	0x34A8,0x01,
	0x34A9,0xE4,
	0x34AA,0xF6,
	0x34AB,0x1C,
	0x34AC,0xC2,
	0x34AD,0xC1,
	0x34AE,0x7F,
	0x34AF,0x23,
	0x34B0,0x0B,
	0x34B1,0xF6,
	0x34B2,0x1C,
	0x34B3,0xC2,
	0x34B4,0xC1,
	0x34B5,0x90,
	0x34B6,0x24,
	0x34B7,0x04,
	0x34B8,0xC6,
	0x34B9,0x01,
	0x34BA,0x20,
	0x34BB,0x2D,
	0x34BC,0xF6,
	0x34BD,0x1C,
	0x34BE,0xC2,
	0x34BF,0xC1,
	0x34C0,0x90,
	0x34C1,0x25,
	0x34C2,0x0B,
	0x34C3,0xF6,
	0x34C4,0x1C,
	0x34C5,0xC2,
	0x34C6,0xC1,
	0x34C7,0xA0,
	0x34C8,0x24,
	0x34C9,0x04,
	0x34CA,0xC6,
	0x34CB,0x02,
	0x34CC,0x20,
	0x34CD,0x1B,
	0x34CE,0xF6,
	0x34CF,0x1C,
	0x34D0,0xC2,
	0x34D1,0xC1,
	0x34D2,0xA0,
	0x34D3,0x25,
	0x34D4,0x0B,
	0x34D5,0xF6,
	0x34D6,0x1C,
	0x34D7,0xC2,
	0x34D8,0xC1,
	0x34D9,0xD0,
	0x34DA,0x24,
	0x34DB,0x04,
	0x34DC,0xC6,
	0x34DD,0x03,
	0x34DE,0x20,
	0x34DF,0x09,
	0x34E0,0xF6,
	0x34E1,0x1C,
	0x34E2,0xC2,
	0x34E3,0xC1,
	0x34E4,0xD0,
	0x34E5,0x25,
	0x34E6,0x04,
	0x34E7,0xC6,
	0x34E8,0x04,
	0x34E9,0x8D,
	0x34EA,0xA0,
	0x34EB,0xF6,
	0x34EC,0x20,
	0x34ED,0x09,
	0x34EE,0xC4,
	0x34EF,0x0F,
	0x34F0,0xF7,
	0x34F1,0x01,
	0x34F2,0xEB,
	0x34F3,0x7A,
	0x34F4,0x01,
	0x34F5,0xEC,
	0x34F6,0xF6,
	0x34F7,0x01,
	0x34F8,0xE4,
	0x34F9,0xF1,
	0x34FA,0x01,
	0x34FB,0xEB,
	0x34FC,0x27,
	0x34FD,0x0C,
	0x34FE,0xC6,
	0x34FF,0x01,
	0x3500,0x37,
	0x3501,0xC6,
	0x3502,0x51,
	0x3503,0xBD,
	0x3504,0xD3,
	0x3505,0xDF,
	0x3506,0x31,
	0x3507,0xC6,
	0x3508,0x01,
	0x3509,0x39,
	0x350A,0x5F,
	0x350B,0x39,
	0x350C,0xF6,
	0x350D,0x01,
	0x350E,0xC0,
	0x350F,0xC1,
	0x3510,0x13,
	0x3511,0x25,
	0x3512,0x03,
	0x3513,0x7E,
	0x3514,0x35,
	0x3515,0xC3,
	0x3516,0xBD,
	0x3517,0xEE,
	0x3518,0x8F,
	0x3519,0x35,
	0x351A,0x40,
	0x351B,0x35,
	0x351C,0x43,
	0x351D,0x35,
	0x351E,0x5D,
	0x351F,0x35,
	0x3520,0x61,
	0x3521,0x35,
	0x3522,0x65,
	0x3523,0x35,
	0x3524,0x71,
	0x3525,0x35,
	0x3526,0x75,
	0x3527,0x35,
	0x3528,0x82,
	0x3529,0x35,
	0x352A,0x86,
	0x352B,0x35,
	0x352C,0x8A,
	0x352D,0x35,
	0x352E,0x8E,
	0x352F,0x35,
	0x3530,0x91,
	0x3531,0x35,
	0x3532,0x95,
	0x3533,0x35,
	0x3534,0x99,
	0x3535,0x35,
	0x3536,0xAE,
	0x3537,0x35,
	0x3538,0xB2,
	0x3539,0x35,
	0x353A,0xB6,
	0x353B,0x35,
	0x353C,0xBA,
	0x353D,0x35,
	0x353E,0xBD,
	0x353F,0x39,
	0x3540,0xBD,
	0x3541,0xBC,
	0x3542,0x25,
	0x3543,0xF6,
	0x3544,0x00,
	0x3545,0x46,
	0x3546,0x4F,
	0x3547,0xC4,
	0x3548,0x0C,
	0x3549,0x83,
	0x354A,0x00,
	0x354B,0x08,
	0x354C,0x26,
	0x354D,0x75,
	0x354E,0xBD,
	0x354F,0xBC,
	0x3550,0x33,
	0x3551,0xF6,
	0x3552,0x01,
	0x3553,0xFF,
	0x3554,0xF7,
	0x3555,0x20,
	0x3556,0xA5,
	0x3557,0xC6,
	0x3558,0x08,
	0x3559,0xF7,
	0x355A,0x20,
	0x355B,0xA8,
	0x355C,0x39,
	0x355D,0xBD,
	0x355E,0xBC,
	0x355F,0x71,
	0x3560,0x39,
	0x3561,0xBD,
	0x3562,0xBC,
	0x3563,0x94,
	0x3564,0x39,
	0x3565,0xBD,
	0x3566,0xBD,
	0x3567,0x07,
	0x3568,0xC6,
	0x3569,0x02,
	0x356A,0x37,
	0x356B,0xC6,
	0x356C,0x51,
	0x356D,0xBD,
	0x356E,0xD3,
	0x356F,0xDF,
	0x3570,0x31,
	0x3571,0xBD,
	0x3572,0xBD,
	0x3573,0x38,
	0x3574,0x39,
	0x3575,0xBD,
	0x3576,0xBD,
	0x3577,0x90,
	0x3578,0xC6,
	0x3579,0x02,
	0x357A,0x37,
	0x357B,0xC6,
	0x357C,0x51,
	0x357D,0xBD,
	0x357E,0xD3,
	0x357F,0xDF,
	0x3580,0x31,
	0x3581,0x39,
	0x3582,0xBD,
	0x3583,0xBD,
	0x3584,0xC0,
	0x3585,0x39,
	0x3586,0xBD,
	0x3587,0xBE,
	0x3588,0x07,
	0x3589,0x39,
	0x358A,0xBD,
	0x358B,0xBE,
	0x358C,0x6A,
	0x358D,0x39,
	0x358E,0xBD,
	0x358F,0xBE,
	0x3590,0xB0,
	0x3591,0xBD,
	0x3592,0xBF,
	0x3593,0x05,
	0x3594,0x39,
	0x3595,0xBD,
	0x3596,0xC0,
	0x3597,0x60,
	0x3598,0x39,
	0x3599,0xBD,
	0x359A,0xC0,
	0x359B,0x7E,
	0x359C,0xF6,
	0x359D,0x01,
	0x359E,0xFE,
	0x359F,0xF7,
	0x35A0,0x1C,
	0x35A1,0xC0,
	0x35A2,0xBD,
	0x35A3,0x9A,
	0x35A4,0xD9,
	0x35A5,0xC6,
	0x35A6,0x02,
	0x35A7,0x37,
	0x35A8,0xC6,
	0x35A9,0x51,
	0x35AA,0xBD,
	0x35AB,0xD3,
	0x35AC,0xDF,
	0x35AD,0x31,
	0x35AE,0xBD,
	0x35AF,0xC0,
	0x35B0,0xB2,
	0x35B1,0x39,
	0x35B2,0xBD,
	0x35B3,0xC0,
	0x35B4,0xDD,
	0x35B5,0x39,
	0x35B6,0xBD,
	0x35B7,0xC1,
	0x35B8,0x7E,
	0x35B9,0x39,
	0x35BA,0xBD,
	0x35BB,0xC1,
	0x35BC,0x9F,
	0x35BD,0x7F,
	0x35BE,0x20,
	0x35BF,0xA8,
	0x35C0,0xBD,
	0x35C1,0xC1,
	0x35C2,0xBF,
	0x35C3,0x39,
	0x35C4,0x3C,
	0x35C5,0xF6,
	0x35C6,0x00,
	0x35C7,0x46,
	0x35C8,0x4F,
	0x35C9,0xC4,
	0x35CA,0x03,
	0x35CB,0x83,
	0x35CC,0x00,
	0x35CD,0x02,
	0x35CE,0x27,
	0x35CF,0x02,
	0x35D0,0x38,
	0x35D1,0x39,
	0x35D2,0xF6,
	0x35D3,0x00,
	0x35D4,0x47,
	0x35D5,0xC4,
	0x35D6,0xFC,
	0x35D7,0xCA,
	0x35D8,0x02,
	0x35D9,0xF7,
	0x35DA,0x00,
	0x35DB,0x47,
	0x35DC,0xFE,
	0x35DD,0x00,
	0x35DE,0xB5,
	0x35DF,0xAD,
	0x35E0,0x00,
	0x35E1,0xF6,
	0x35E2,0x02,
	0x35E3,0x00,
	0x35E4,0xF7,
	0x35E5,0x20,
	0x35E6,0xA5,
	0x35E7,0x13,
	0x35E8,0x00,
	0x35E9,0x10,
	0x35EA,0x03,
	0x35EB,0x7F,
	0x35EC,0x12,
	0x35ED,0x37,
	0x35EE,0xF6,
	0x35EF,0x01,
	0x35F0,0xEE,
	0x35F1,0xF7,
	0x35F2,0x12,
	0x35F3,0x36,
	0x35F4,0xC6,
	0x35F5,0x01,
	0x35F6,0xF7,
	0x35F7,0x12,
	0x35F8,0x51,
	0x35F9,0x5C,
	0x35FA,0xF7,
	0x35FB,0x01,
	0x35FC,0xBF,
	0x35FD,0x38,
	0x35FE,0x39,
	0x35FF,0xF6,
	0x3600,0x01,
	0x3601,0xBF,
	0x3602,0xC1,
	0x3603,0x0B,
	0x3604,0x24,
	0x3605,0x41,
	0x3606,0xBD,
	0x3607,0xEE,
	0x3608,0x8F,
	0x3609,0x36,
	0x360A,0x20,
	0x360B,0x36,
	0x360C,0x23,
	0x360D,0x36,
	0x360E,0x26,
	0x360F,0x36,
	0x3610,0x29,
	0x3611,0x36,
	0x3612,0x31,
	0x3613,0x36,
	0x3614,0x35,
	0x3615,0x36,
	0x3616,0x39,
	0x3617,0x36,
	0x3618,0x44,
	0x3619,0x36,
	0x361A,0x2D,
	0x361B,0x36,
	0x361C,0x3D,
	0x361D,0x36,
	0x361E,0x41,
	0x361F,0x39,
	0x3620,0xBD,
	0x3621,0xC2,
	0x3622,0x47,
	0x3623,0x8D,
	0x3624,0x9F,
	0x3625,0x39,
	0x3626,0xBD,
	0x3627,0xC2,
	0x3628,0x86,
	0x3629,0xBD,
	0x362A,0xC2,
	0x362B,0xC0,
	0x362C,0x39,
	0x362D,0xBD,
	0x362E,0xC3,
	0x362F,0x40,
	0x3630,0x39,
	0x3631,0xBD,
	0x3632,0xC4,
	0x3633,0x07,
	0x3634,0x39,
	0x3635,0xBD,
	0x3636,0xC4,
	0x3637,0x45,
	0x3638,0x39,
	0x3639,0xBD,
	0x363A,0xC4,
	0x363B,0x98,
	0x363C,0x39,
	0x363D,0xBD,
	0x363E,0xC4,
	0x363F,0xF3,
	0x3640,0x39,
	0x3641,0xBD,
	0x3642,0xC5,
	0x3643,0x14,
	0x3644,0xBD,
	0x3645,0xC5,
	0x3646,0x2E,
	0x3647,0x39,
	0x3648,0x00,
	0x3649,0x04,
	0x364A,0x08,
	0x364B,0x09,
	0x364C,0x0D,
	0x364D,0x0E,
	0x364E,0x0F,
	0x364F,0x00,
	0x3400,0x01,
	0x33f8,0x01
};

int set_phy_expanded_access_mode(struct phy_device *phy_dev, int access_mode)
{
	int v, ret;

	v = phy_read(phy_dev, MII_MISC_CTL);
	v &= (~0x3);
	v |= (access_mode & 0x3);
	ret = phy_write(phy_dev, MII_MISC_CTL, v);

	return ret;
}

int phy_expanded_read(struct phy_device *phy_dev, u32 reg_addr)
{
	int v, ret;

	v = phy_read(phy_dev, MII_BMCR);
	v |= BMCR_PDOWN;
	phy_write(phy_dev, MII_BMCR, v);

	phy_write(phy_dev, MII_EXPMA, reg_addr);
	ret = phy_read(phy_dev, MII_EXPMD);

	v = phy_read(phy_dev, MII_BMCR);
	v &= (~BMCR_PDOWN);
	phy_write(phy_dev, MII_BMCR, v);

	return ret;
}

int phy_expanded_write(struct phy_device *phy_dev, u32 reg_addr, u16 val)
{
	int v, ret;

	v = phy_read(phy_dev, MII_BMCR);
	v |= BMCR_PDOWN;
	phy_write(phy_dev, MII_BMCR, v);

	phy_write(phy_dev, MII_EXPMA, reg_addr);
	ret = phy_write(phy_dev, MII_EXPMD, val);

	v = phy_read(phy_dev, MII_BMCR);
	v &= (~BMCR_PDOWN);
	phy_write(phy_dev, MII_BMCR, v);

	return ret;
}

int phy_expanded_write_bulk(struct phy_device *phy_dev, const u32 reg_and_val[],
			    int count)
{
	int i, v, ret = 0;
	u32 reg_addr;
	u16 val;

	v = phy_read(phy_dev, MII_BMCR);
	v |= BMCR_PDOWN;
	phy_write(phy_dev, MII_BMCR, v);

	for (i = 0; i < (2 * count); i += 2) {
		if ((i % 50) == 0)
			schedule();
		
		reg_addr = reg_and_val[i];
		val = (u16) reg_and_val[i + 1];
		phy_write(phy_dev, MII_EXPMA, reg_addr);
		ret = phy_write(phy_dev, MII_EXPMD, val);
	}

	v = phy_read(phy_dev, MII_BMCR);
	v &= (~BMCR_PDOWN);
	phy_write(phy_dev, MII_BMCR, v);

	return ret;
}

/* fix FEPHY for better eye diagram */
int hisilicon_fephy_fix(struct phy_device *phy_dev)
{
	int count;

	count = sizeof(phy_fix_param) / sizeof(phy_fix_param[0]);
	if (count % 2)
		pr_warn("internal FEPHY fix register count is not right.\n");
	count /= 2;

	phy_expanded_write_bulk(phy_dev, phy_fix_param, count);

	return 0;
}

/*
 * for a better Electromagnetic Compatibility
 */
int realtek_gephy_fix(struct phy_device *phy_dev)
{
#if 0
	int v;

	pr_info("RealTek phy fix: phy id=0x%x\n", phy_dev->phy_id);

	v = phy_read(phy_dev, 16);      /* PHYCR reg */
	v |= 1 << 4;                    /* clk125 remains at logic low */
	phy_write(phy_dev, 16, v);

	phy_write(phy_dev, 31, 0x0007);	/* set to extension page */
	phy_write(phy_dev, 30, 0x00A0);	/* set to extension page 160 */

	v = phy_read(phy_dev, 26);
	v &= ~(1 << 2);			/* enable RXC SSC */
	phy_write(phy_dev, 26, v);

	phy_write(phy_dev, 31, 0x0);	/* back to page 0 */

#endif

	return 0;
}

/* copy from phy_quirk() in hieth-sf/net.c */
int KSZ8051MNL_phy_fix(struct phy_device *phy_dev)
{
	u32 v;

	v = phy_read(phy_dev, 0x1F);
	v |= (1 << 7);       /* set phy RMII 50MHz clk; */
	phy_write(phy_dev, 0x1F, v);

	v = phy_read(phy_dev, 0x16);
	v |= (1 << 1);       /* set phy RMII override; */
	phy_write(phy_dev, 0x16, v);

	return 0;
}

/* copy from phy_quirk() in hieth-sf/net.c */
int KSZ8081RNB_phy_fix(struct phy_device *phy_dev)
{
	u32 v;

	v = phy_read(phy_dev, 0x1F);
	v |= (1 << 7);       /* set phy RMII 50MHz clk; */
	phy_write(phy_dev, 0x1F, v);

	return 0;
}

void phy_register_fixups(void)
{
	phy_register_fixup_for_uid(REALTEK_PHY_ID_8211EG,
			REALTEK_PHY_MASK, realtek_gephy_fix);
	phy_register_fixup_for_uid(HISILICON_PHY_ID_FESTAV200,
			HISILICON_PHY_MASK, hisilicon_fephy_fix);
	phy_register_fixup_for_uid(PHY_ID_KSZ8051MNL,
			DEFAULT_PHY_MASK, KSZ8051MNL_phy_fix);
	phy_register_fixup_for_uid(PHY_ID_KSZ8081RNB,
			DEFAULT_PHY_MASK, KSZ8081RNB_phy_fix);
}
